<!DOCTYPE html>
<html lang="ru" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–ª–∞—Ç–µ–∂–µ–π iOS 17 —Å—Ç–∏–ª—å</title>
  <style>
    /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã Apple */
    @font-face {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
    }
    :root {
      --color-bg-light: #fff;
      --color-bg-dark: #1c1c1e;
      --color-text-light: #000;
      --color-text-dark: #f2f2f7;
      --color-primary-light: #0a84ff;
      --color-primary-dark: #0a84ff;
      --color-day-current-light: #0a84ff;
      --color-day-current-dark: #0a84ff;
      --color-shadow-light: rgba(0, 0, 0, 0.1);
      --color-shadow-dark: rgba(0, 0, 0, 0.7);

      --color-category-–∏–ø–æ—Ç–µ–∫–∞: #f2b3b3;       /* –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π */
      --color-category-–∫–æ–º–º—É–Ω–∞–ª–∫–∞: #f2d9b3;   /* –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
      --color-category-–∫—Ä–µ–¥–∏—Ç: #b3d9f2;       /* –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –≥–æ–ª—É–±–æ–π */
      --color-category-–ø–æ–¥–ø–∏—Å–∫–∏: #c7b3f2;     /* –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π —Å–∏—Ä–µ–Ω–µ–≤—ã–π */
      --color-category-–¥—Ä—É–≥–∏–µ: #d9d9d9;       /* –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä—ã–π */

      --color-income: #4cd964; /* –∑–µ–ª–µ–Ω—ã–π */
      --color-overlay-light: rgba(0,0,0,0.3);
      --color-overlay-dark: rgba(255,255,255,0.15);

      --radius: 16px;
      --shadow-elevation: 0 6px 12px var(--color-shadow-light);
      --shadow-elevation-dark: 0 6px 12px var(--color-shadow-dark);
      --animation-duration: 0.25s;
      --animation-easing: cubic-bezier(0.4, 0, 0.2, 1);
    }
    /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg: var(--color-bg-dark);
        --color-text: var(--color-text-dark);
        --color-primary: var(--color-primary-dark);
        --color-day-current: var(--color-day-current-dark);
        --color-shadow: var(--color-shadow-dark);
        --shadow-elevation: var(--shadow-elevation-dark);
        --color-overlay: var(--color-overlay-dark);
      }
    }
    /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    :root {
      --color-bg: var(--color-bg-light);
      --color-text: var(--color-text-light);
      --color-primary: var(--color-primary-light);
      --color-day-current: var(--color-day-current-light);
      --color-shadow: var(--color-shadow-light);
      --color-overlay: var(--color-overlay-light);
    }

    /* –°–±—Ä–æ—Å */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--color-bg);
      color: var(--color-text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue",
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    #app {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom);
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
      min-height: 100vh;
      background: var(--color-bg);
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –º–µ—Å—è—Ü–µ–º */
    header {
      text-align: center;
      padding: 14px 16px 10px;
      font-weight: 600;
      font-size: 1.3rem;
      letter-spacing: 0.02em;
      position: relative;
      user-select: none;
    }
    /* –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ—Å—è—Ü–∞ */
    .nav-month {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--color-primary);
      cursor: pointer;
      padding: 6px 12px;
      border-radius: var(--radius);
      transition: background-color 0.3s;
    }
    .nav-month:hover {
      background-color: var(--color-overlay);
    }
    #prevMonth {
      left: 10px;
    }
    #nextMonth {
      right: 10px;
    }

    /* –°–µ—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px 6px;
      padding: 0 12px 20px;
      user-select: none;
    }
    /* –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ */
    .weekday {
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
      padding: 4px 0;
      color: var(--color-primary);
      user-select: none;
    }
    /* –ö–ª–µ—Ç–∫–∞ –¥–Ω—è */
    .day-cell {
      background: transparent;
      border-radius: var(--radius);
      padding: 10px 6px 18px;
      position: relative;
      text-align: center;
      cursor: pointer;
      transition:
        background-color var(--animation-duration) var(--animation-easing),
        color var(--animation-duration) var(--animation-easing);
      font-weight: 600;
      font-size: 1rem;
      color: var(--color-text);
      user-select: none;
    }
    .day-cell:hover {
      background-color: var(--color-overlay);
    }
    /* –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞ (–¥–ª—è –¥–Ω–µ–π —Å–æ—Å–µ–¥–Ω–∏—Ö –º–µ—Å—è—Ü–µ–≤) */
    .day-cell.empty {
      pointer-events: none;
      opacity: 0.2;
      cursor: default;
    }
    /* –¢–µ–∫—É—â–∏–π –¥–µ–Ω—å - –∫—Ä—É–∂–æ–∫ –∫–∞–∫ –≤ iOS */
    .day-cell.today > .day-number {
      background-color: var(--color-day-current);
      color: #fff;
      width: 32px;
      height: 32px;
      line-height: 32px;
      margin: 0 auto;
      border-radius: 50%;
      font-weight: 700;
      user-select: none;
      position: relative;
      z-index: 2;
    }
    .day-cell .day-number {
      display: inline-block;
      width: 32px;
      height: 32px;
      line-height: 32px;
      border-radius: 50%;
      user-select: none;
      position: relative;
      z-index: 1;
    }
    /* –¢–æ—á–∫–∏ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ —Å–Ω–∏–∑—É */
    .day-cell .dots {
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      justify-content: center;
      pointer-events: none;
      z-index: 3;
      flex-wrap: wrap;
      max-width: 48px;
      margin: 0 auto;
    }
    .day-cell .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--color-primary);
      box-shadow: 0 0 4px rgba(0,0,0,0.1);
      transition: background-color 0.3s;
      flex-shrink: 0;
    }
    /* –†–∞–∑–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
    .dot.–∏–ø–æ—Ç–µ–∫–∞ { background-color: var(--color-category-–∏–ø–æ—Ç–µ–∫–∞); }
    .dot.–∫–æ–º–º—É–Ω–∞–ª–∫–∞ { background-color: var(--color-category-–∫–æ–º–º—É–Ω–∞–ª–∫–∞); }
    .dot.–∫—Ä–µ–¥–∏—Ç { background-color: var(--color-category-–∫—Ä–µ–¥–∏—Ç); }
    .dot.–ø–æ–¥–ø–∏—Å–∫–∏ { background-color: var(--color-category-–ø–æ–¥–ø–∏—Å–∫–∏); }
    .dot.–¥—Ä—É–≥–∏–µ { background-color: var(--color-category-–¥—Ä—É–≥–∏–µ); }
    .dot.–¥–æ—Ö–æ–¥ { background-color: var(--color-income); }

    /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ "+" */
    #addPaymentBtn {
      position: fixed;
      right: 20px;
      bottom: env(safe-area-inset-bottom,20px);
      background-color: var(--color-primary);
      width: 56px;
      height: 56px;
      border-radius: 50%;
      color: white;
      font-size: 36px;
      line-height: 56px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      box-shadow: var(--shadow-elevation);
      border: none;
      transition: background-color 0.25s;
      z-index: 1000;
    }
    #addPaymentBtn:hover {
      background-color: #006fee;
    }
    /* –û–≤–µ—Ä–ª–µ–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    .overlay {
      position: fixed;
      inset: 0;
      background: var(--color-overlay);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      animation: fadeIn var(--animation-duration) var(--animation-easing);
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    .modal {
      background: var(--color-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-elevation);
      width: 90vw;
      max-width: 400px;
      max-height: 90vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding: 16px 20px;
      animation: slideUp var(--animation-duration) var(--animation-easing);
      position: relative;
    }
    @keyframes slideUp {
      from {transform: translateY(20px); opacity: 0;}
      to {transform: translateY(0); opacity: 1;}
    }
    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal-header {
      font-weight: 700;
      font-size: 1.25rem;
      margin-bottom: 12px;
      text-align: center;
      user-select: none;
    }
    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: var(--color-primary);
      cursor: pointer;
      user-select: none;
      padding: 2px 6px;
      border-radius: var(--radius);
      transition: background-color 0.25s;
    }
    .modal-close:hover {
      background-color: var(--color-overlay);
    }
    /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ */
    form label {
      font-weight: 600;
      margin-top: 12px;
      display: block;
      font-size: 0.9rem;
      user-select: none;
    }
    form input[type=text],
    form input[type=number],
    form select,
    form input[type=date] {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1.5px solid #ccc;
      font-size: 1rem;
      background: var(--color-bg);
      color: var(--color-text);
      outline-offset: 2px;
      transition: border-color 0.25s;
      user-select: text;
    }
    form input[type=text]:focus,
    form input[type=number]:focus,
    form select:focus,
    form input[type=date]:focus {
      border-color: var(--color-primary);
    }
    /* –¶–≤–µ—Ç–Ω–∞—è –º–µ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ */
    .color-picker {
      margin-top: 6px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .color-picker button {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border-color 0.3s;
      flex-shrink: 0;
    }
    .color-picker button.selected {
      border-color: var(--color-primary);
    }
    /* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã */
    form button[type=submit] {
      margin-top: 20px;
      background-color: var(--color-primary);
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      border: none;
      border-radius: var(--radius);
      padding: 12px 0;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    form button[type=submit]:hover {
      background-color: #006fee;
    }
    /* –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π –≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –¥–Ω—è */
    .payment-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 50vh;
      overflow-y: auto;
    }
    .payment-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 6px;
      border-bottom: 1px solid var(--color-overlay);
      align-items: center;
      user-select: none;
    }
    .payment-item:last-child {
      border-bottom: none;
    }
    .payment-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      max-width: 70%;
      overflow-wrap: break-word;
    }
    .payment-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--color-text);
    }
    .payment-category {
      font-size: 0.85rem;
      color: var(--color-primary);
      opacity: 0.75;
    }
    .payment-sum {
      font-weight: 700;
      font-size: 1rem;
      user-select: text;
      white-space: nowrap;
    }
    /* –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è */
    .payment-actions {
      display: flex;
      gap: 8px;
    }
    .payment-action-btn {
      background: transparent;
      border: none;
      color: var(--color-primary);
      font-size: 1.2rem;
      cursor: pointer;
      user-select: none;
      padding: 2px 6px;
      border-radius: var(--radius);
      transition: background-color 0.3s;
    }
    .payment-action-btn:hover {
      background-color: var(--color-overlay);
    }
    /* –û–±—â–∞—è —Å—É–º–º–∞ –¥–Ω—è */
    .day-total {
      margin-top: 12px;
      font-weight: 700;
      font-size: 1.15rem;
      text-align: right;
      user-select: none;
      color: var(--color-primary);
    }
    /* –ü–æ–∏—Å–∫ */
    #searchInput {
      margin: 10px 16px 0 16px;
      width: calc(100% - 32px);
      padding: 10px 12px;
      font-size: 1rem;
      border-radius: var(--radius);
      border: 1.5px solid #ccc;
      outline-offset: 2px;
      user-select: text;
      color: var(--color-text);
      background: var(--color-bg);
      transition: border-color 0.25s;
    }
    #searchInput:focus {
      border-color: var(--color-primary);
    }
    /* –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ */
    #searchResults {
      list-style: none;
      padding: 0 16px;
      margin: 6px 0 16px;
      max-height: 150px;
      overflow-y: auto;
      user-select: none;
    }
    #searchResults li {
      padding: 8px 10px;
      border-bottom: 1px solid var(--color-overlay);
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #searchResults li:hover {
      background-color: var(--color-overlay);
    }
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    #stats {
      padding: 0 16px 16px 16px;
      user-select: none;
    }
    #stats h3 {
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
    }
    .stat-bar {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      align-items: center;
    }
    .stat-label {
      flex: 1 0 100px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .stat-value {
      flex: 0 0 60px;
      text-align: right;
      font-weight: 700;
    }
    .stat-color {
      width: 24px;
      height: 16px;
      border-radius: var(--radius);
      flex-shrink: 0;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (min-width: 400px) {
      .day-cell .day-number {
        width: 36px;
        height: 36px;
        line-height: 36px;
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div id="app" role="main" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø–ª–∞—Ç–µ–∂–µ–π">
    <header>
      <button id="prevMonth" class="nav-month" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü" tabindex="0">&lsaquo;</button>
      <span id="monthYear" aria-live="polite" aria-atomic="true"></span>
      <button id="nextMonth" class="nav-month" aria-label="–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü" tabindex="0">&rsaquo;</button>
</header>

<!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
<div class="calendar-grid" aria-label="–î–Ω–∏ –Ω–µ–¥–µ–ª–∏">
  <div class="weekday">–ü–Ω</div>
  <div class="weekday">–í—Ç</div>
  <div class="weekday">–°—Ä</div>
  <div class="weekday">–ß—Ç</div>
  <div class="weekday">–ü—Ç</div>
  <div class="weekday">–°–±</div>
  <div class="weekday">–í—Å</div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
<div id="calendar" class="calendar-grid" aria-label="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Å—è—Ü–∞" tabindex="0"></div>

<!-- –ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–µ–π -->
<input type="search" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–µ–π..." aria-label="–ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–µ–π" autocomplete="off">
<ul id="searchResults" role="listbox" aria-label="–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞"></ul>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div id="stats" aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"></div>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ -->
<button id="addPaymentBtn" aria-label="–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂" title="–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂">+</button>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ -->
<div id="paymentModal" class="overlay" hidden role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal">
    <button class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
    <h2 id="modalTitle" class="modal-header">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</h2>
    <form id="paymentForm">
      <input type="hidden" id="paymentId">
      <label for="paymentName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</label>
      <input type="text" id="paymentName" name="paymentName" required autocomplete="off" maxlength="50" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ò–ø–æ—Ç–µ–∫–∞">
      
      <label for="paymentSum">–°—É–º–º–∞ (‚ÇΩ)</label>
      <input type="number" id="paymentSum" name="paymentSum" required min="0" step="0.01" placeholder="10000">
      
      <label for="paymentDate">–î–∞—Ç–∞</label>
      <input type="date" id="paymentDate" name="paymentDate" required>
      
      <label for="paymentCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="paymentCategory" name="paymentCategory" required>
        <option value="–∏–ø–æ—Ç–µ–∫–∞">–ò–ø–æ—Ç–µ–∫–∞</option>
        <option value="–∫–æ–º–º—É–Ω–∞–ª–∫–∞">–ö–æ–º–º—É–Ω–∞–ª–∫–∞</option>
        <option value="–∫—Ä–µ–¥–∏—Ç">–ö—Ä–µ–¥–∏—Ç</option>
        <option value="–ø–æ–¥–ø–∏—Å–∫–∏">–ü–æ–¥–ø–∏—Å–∫–∏</option>
        <option value="–¥–æ—Ö–æ–¥">–î–æ—Ö–æ–¥</option>
        <option value="–¥—Ä—É–≥–∏–µ">–î—Ä—É–≥–∏–µ</option>
      </select>
      
      <label for="paymentPeriod">–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å</label>
      <select id="paymentPeriod" name="paymentPeriod" required>
        <option value="—Ä–∞–∑–æ–≤–æ">–†–∞–∑–æ–≤–æ</option>
        <option value="–µ–∂–µ–º–µ—Å—è—á–Ω–æ">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
      </select>
      
      <label>–¶–≤–µ—Ç –º–µ—Ç–∫–∏</label>
      <div class="color-picker" id="colorPicker">
        <!-- –ö–Ω–æ–ø–∫–∏ —Ü–≤–µ—Ç–æ–≤ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–Ω—è -->
<div id="dayViewModal" class="overlay" hidden role="dialog" aria-modal="true" aria-labelledby="dayViewTitle">
  <div class="modal">
    <button class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
    <h2 id="dayViewTitle" class="modal-header"></h2>
    <ul class="payment-list" id="dayPaymentsList"></ul>
    <div class="day-total" id="dayTotalSum"></div>
  </div>
</div>

<script>
(() => {
  'use strict';

  // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ü–≤–µ—Ç–∞
  const CATEGORY_COLORS = {
    –∏–ø–æ—Ç–µ–∫–∞: getComputedStyle(document.documentElement).getPropertyValue('--color-category-–∏–ø–æ—Ç–µ–∫–∞').trim() || '#f2b3b3',
    –∫–æ–º–º—É–Ω–∞–ª–∫–∞: getComputedStyle(document.documentElement).getPropertyValue('--color-category-–∫–æ–º–º—É–Ω–∞–ª–∫–∞').trim() || '#f2d9b3',
    –∫—Ä–µ–¥–∏—Ç: getComputedStyle(document.documentElement).getPropertyValue('--color-category-–∫—Ä–µ–¥–∏—Ç').trim() || '#b3d9f2',
    –ø–æ–¥–ø–∏—Å–∫–∏: getComputedStyle(document.documentElement).getPropertyValue('--color-category-–ø–æ–¥–ø–∏—Å–∫–∏').trim() || '#c7b3f2',
    –¥–æ—Ö–æ–¥: getComputedStyle(document.documentElement).getPropertyValue('--color-income').trim() || '#4cd964',
    –¥—Ä—É–≥–∏–µ: getComputedStyle(document.documentElement).getPropertyValue('--color-category-–¥—Ä—É–≥–∏–µ').trim() || '#d9d9d9',
  };

  // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
  const monthYearEl = document.getElementById('monthYear');
  const prevMonthBtn = document.getElementById('prevMonth');
  const nextMonthBtn = document.getElementById('nextMonth');
  const calendarEl = document.getElementById('calendar');
  const addPaymentBtn = document.getElementById('addPaymentBtn');
  const paymentModal = document.getElementById('paymentModal');
  const paymentForm = document.getElementById('paymentForm');
  const modalCloseBtns = document.querySelectorAll('.modal-close');
  const paymentIdInput = document.getElementById('paymentId');
  const paymentNameInput = document.getElementById('paymentName');
  const paymentSumInput = document.getElementById('paymentSum');
  const paymentDateInput = document.getElementById('paymentDate');
  const paymentCategorySelect = document.getElementById('paymentCategory');
  const paymentPeriodSelect = document.getElementById('paymentPeriod');
  const colorPicker = document.getElementById('colorPicker');
  const dayViewModal = document.getElementById('dayViewModal');
  const dayViewTitle = document.getElementById('dayViewTitle');
  const dayPaymentsList = document.getElementById('dayPaymentsList');
  const dayTotalSum = document.getElementById('dayTotalSum');
  const searchInput = document.getElementById('searchInput');
  const searchResults = document.getElementById('searchResults');
  const statsEl = document.getElementById('stats');

  // –¢–µ–∫—É—â–∏–µ –¥–∞—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –º–µ—Å—è—Ü
  let today = new Date();
  let viewYear = today.getFullYear();
  let viewMonth = today.getMonth(); // 0-11

  // –ü–ª–∞—Ç–µ–∂–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage –≤ —Ñ–æ—Ä–º–∞—Ç–µ {id: string, name: string, sum: number, date: string(ISO), category: string, period: string, color: string}
  let payments = [];

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
  const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
  function loadPayments() {
    const raw = localStorage.getItem('payments');
    if(raw) {
      try {
        payments = JSON.parse(raw);
      } catch {
        payments = [];
      }
    }
  }
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
  function savePayments() {
    localStorage.setItem('payments', JSON.stringify(payments));
  }

  // –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –∫ ISO yyyy-mm-dd
  function formatDate(date) {
    return date.toISOString().slice(0,10);
  }
  // –ü–∞—Ä—Å–∏–Ω–≥ yyyy-mm-dd –∫ –¥–∞—Ç–µ
  function parseDate(str) {
    const parts = str.split('-');
    if(parts.length !== 3) return null;
    return new Date(parts[0], parts[1]-1, parts[2]);
  }

  // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ—Å—è—Ü–∞
  function updateMonthYear() {
    const dt = new Date(viewYear, viewMonth);
    const options = {year: 'numeric', month: 'long'};
    monthYearEl.textContent = dt.toLocaleDateString('ru-RU', options);
  }

  // –ü–æ–ª—É—á–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –Ω–∞ –¥–∞—Ç—É —Å —É—á—ë—Ç–æ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö
  function paymentsOnDate(date) {
    const targetStr = formatDate(date);
    return payments.filter(p => {
      if(p.period === '—Ä–∞–∑–æ–≤–æ') return p.date === targetStr;
      if(p.period === '–µ–∂–µ–º–µ—Å—è—á–Ω–æ') {
        const pDate = parseDate(p.date);
        return pDate && pDate.getDate() === date.getDate() && pDate <= date;
      }
      return false;
    });
  }

  // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—å
  function buildCalendar() {
    calendarEl.innerHTML = '';
    updateMonthYear();

    const firstDay = new Date(viewYear, viewMonth, 1);
    let dayOfWeek = firstDay.getDay();
    dayOfWeek = (dayOfWeek === 0) ? 7 : dayOfWeek; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫=1 ... –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ=7

    const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
    const prevMonthDays = new Date(viewYear, viewMonth, 0).getDate();

    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    for(let i=dayOfWeek-1; i>0; i--) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'day-cell empty';
      emptyCell.setAttribute('aria-disabled', 'true');
      calendarEl.appendChild(emptyCell);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    for(let d=1; d<=daysInMonth; d++) {
      const dateObj = new Date(viewYear, viewMonth, d);
      const dayCell = document.createElement('div');
      dayCell.className = 'day-cell';
      dayCell.setAttribute('tabindex', '0');
      dayCell.setAttribute('role', 'button');
      dayCell.setAttribute('aria-label', `–î–µ–Ω—å ${d} ${dateObj.toLocaleDateString('ru-RU', {month:'long', year:'numeric'})}`);
      dayCell.dataset.date = formatDate(dateObj);

      const dayNumber = document.createElement('span');
      dayNumber.className = 'day-number';
      dayNumber.textContent = d;

      // –í—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –∫—Ä—É–∂–∫–æ–º
      const now = new Date();
      if(now.getFullYear()===viewYear && now.getMonth()===viewMonth && now.getDate()===d) {
        dayCell.classList.add('today');
      }
      dayCell.appendChild(dayNumber);

      // –î–æ–±–∞–≤–∏—Ç—å —Ü–≤–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
      const dayPayments = paymentsOnDate(dateObj);
      if(dayPayments.length) {
        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'dots';
        const uniqueCategories = [...new Set(dayPayments.map(p => p.category))];
        uniqueCategories.slice(0,4).forEach(cat => {
          const dot = document.createElement('span');
          dot.className = `dot ${cat}`;
          dot.style.backgroundColor = CATEGORY_COLORS[cat] || CATEGORY_COLORS.–¥—Ä—É–≥–∏–µ;
          dotsContainer.appendChild(dot);
        });
        dayCell.appendChild(dotsContainer);
      }

      // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–Ω—è –ø—Ä–∏ –∫–ª–∏–∫–µ –∏–ª–∏ –∫–ª–∞–≤–∏—à–µ Enter/Space
      dayCell.addEventListener('click', () => openDayView(dateObj));
      dayCell.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openDayView(dateObj);
        }
      });

      calendarEl.appendChild(dayCell);
    }

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ—Ç–∫—É, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–æ 42 —è—á–µ–π–∫–∏ (6 –Ω–µ–¥–µ–ª—å)
    const totalCells = calendarEl.children.length;
    for(let i=totalCells; i<42; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'day-cell empty';
      emptyCell.setAttribute('aria-disabled', 'true');
      calendarEl.appendChild(emptyCell);
    }
  }

  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ (–ø—É—Å—Ç–∞—è —Ñ–æ—Ä–º–∞)
  function openAddPayment(date = null) {
    resetPaymentForm();
    paymentModal.querySelector('h2').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂';
    paymentModal.hidden = false;
    paymentModal.style.display = 'flex';
    if(date) {
      paymentDateInput.value = formatDate(date);
    } else {
      paymentDateInput.value = formatDate(today);
    }
    paymentNameInput.focus();
  }

  // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
  function resetPaymentForm() {
    paymentIdInput.value = '';
    paymentNameInput.value = '';
    paymentSumInput.value = '';
    paymentDateInput.value = '';
    paymentCategorySelect.value = '–∏–ø–æ—Ç–µ–∫–∞';
    paymentPeriodSelect.value = '—Ä–∞–∑–æ–≤–æ';
    selectColorButtonByCategory(paymentCategorySelect.value);
  }

  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–Ω—è
  function openDayView(date) {
    dayViewTitle.textContent = `–ü–ª–∞—Ç–µ–∂–∏ ${date.toLocaleDateString('ru-RU', {day: 'numeric', month: 'long', year: 'numeric'})}`;
    dayPaymentsList.innerHTML = '';
    const dayPayments = paymentsOnDate(date).sort((a,b) => a.name.localeCompare(b.name));
    if(dayPayments.length === 0) {
      const emptyMsg = document.createElement('li');
      emptyMsg.textContent = '–ü–ª–∞—Ç–µ–∂–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
      emptyMsg.style.padding = '10px';
      dayPaymentsList.appendChild(emptyMsg);
      dayTotalSum.textContent = '';
    } else {
      let total = 0;
      dayPayments.forEach(p => {
        const li = document.createElement('li');
        li.className = 'payment-item';
        // –ò–Ω—Ñ–æ
        const info = document.createElement('div');
        info.className = 'payment-info';

        const name = document.createElement('div');
        name.className = 'payment-name';
        name.textContent = p.name;
        info.appendChild(name);

        const category = document.createElement('div');
        category.className = 'payment-category';
        category.textContent = capitalize(p.category);
        info.appendChild(category);

        li.appendChild(info);

        // –°—É–º–º–∞
        const sum = document.createElement('div');
        sum.className = 'payment-sum';
        const sumFormatted = Number(p.sum).toLocaleString('ru-RU', {style:'currency', currency:'RUB', minimumFractionDigits: 2});
        sum.textContent = sumFormatted;
        if(p.category === '–¥–æ—Ö–æ–¥') sum.style.color = CATEGORY_COLORS.–¥–æ—Ö–æ || '#4cd964';
        li.appendChild(sum);

        // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
        const actions = document.createElement('div');
        actions.className = 'payment-actions';

        const editBtn = document.createElement('button');
        editBtn.className = 'payment-action-btn';
        editBtn.setAttribute('aria-label', `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂ ${p.name}`);
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.addEventListener('click', e => {
          e.stopPropagation();
          openEditPayment(p.id);
        });
        actions.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'payment-action-btn';
        delBtn.setAttribute('aria-label', `–£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂ ${p.name}`);
        delBtn.innerHTML = 'üóëÔ∏è';
        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          if(confirm(`–£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂ "${p.name}"?`)) {
            deletePayment(p.id);
            openDayView(date);
            buildCalendar();
            updateStats();
          }
        });
        actions.appendChild(delBtn);

        li.appendChild(actions);
        dayPaymentsList.appendChild(li);

        total += Number(p.sum);
      });
      const totalFormatted = total.toLocaleString('ru-RU', {style:'currency', currency:'RUB', minimumFractionDigits: 2});
      dayTotalSum.textContent = `–ò—Ç–æ–≥–æ: ${totalFormatted}`;
    }
    dayViewModal.hidden = false;
    dayViewModal.style.display = 'flex';
  }

  // –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ–≤–∞
  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // –ó–∞–∫—Ä—ã—Ç—å –ª—é–±–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  function closeModal(modal) {
    modal.hidden = true;
    modal.style.display = 'none';
  }

  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
  function openEditPayment(id) {
    const payment = payments.find(p => p.id === id);
    if(!payment) return;
    paymentModal.querySelector('h2').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂';
    paymentIdInput.value = payment.id;
    paymentNameInput.value = payment.name;
    paymentSumInput.value = payment.sum;
    paymentDateInput.value = payment.date;
    paymentCategorySelect.value = payment.category;
    paymentPeriodSelect.value = payment.period;
    selectColorButtonByCategory(payment.category, payment.color);
    paymentModal.hidden = false;
    paymentModal.style.display = 'flex';
    paymentNameInput.focus();
  }

  // –£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂
  function deletePayment(id) {
    payments = payments.filter(p => p.id !== id);
    savePayments();
  }

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂ (—Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å)
  function savePayment(data) {
    if(data.id) {
      // –û–±–Ω–æ–≤–∏—Ç—å
      const idx = payments.findIndex(p => p.id === data.id);
      if(idx !== -1) {
        payments[idx] = data;
      }
    } else {
      // –°–æ–∑–¥–∞—Ç—å
      data.id = generateId();
      payments.push(data);
    }
    savePayments();
  }

  // –°–æ–∑–¥–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–µ
  function buildColorPicker() {
    colorPicker.innerHTML = '';
    for (const [cat, color] of Object.entries(CATEGORY_COLORS)) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.title = capitalize(cat);
      btn.style.backgroundColor = color;
      btn.dataset.color = color;
      btn.dataset.category = cat;
      btn.setAttribute('aria-label', `–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${capitalize(cat)}`);
      btn.addEventListener('click', () => {
        selectColorButton(btn);
      });
      colorPicker.appendChild(btn);
    }
  }

  // –í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç–æ–≤—É—é –∫–Ω–æ–ø–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∏ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ü–≤–µ—Ç—É)
  function selectColorButtonByCategory(category, color=null) {
    const buttons = colorPicker.querySelectorAll('button');
    buttons.forEach(b => {
      b.classList.remove('selected');
      if(color) {
        if(b.dataset.color === color) {
          b.classList.add('selected');
        }
      } else {
        if(b.dataset.category === category) {
          b.classList.add('selected');
        }
      }
    });
  }

  // –í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç–æ–≤—É—é –∫–Ω–æ–ø–∫—É (–ø—Ä–∏ –∫–ª–∏–∫–µ)
  function selectColorButton(button) {
    const buttons = colorPicker.querySelectorAll('button');
    buttons.forEach(b => b.classList.remove('selected'));
    button.classList.add('selected');
  }

  // –ü–æ–ª—É—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –∏–∑ —Ñ–æ—Ä–º—ã
  function getSelectedColor() {
    const selected = colorPicker.querySelector('button.selected');
    return selected ? selected.dataset.color : CATEGORY_COLORS.–¥—Ä—É–≥–∏–µ;
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
  paymentForm.addEventListener('submit', e => {
    e.preventDefault();
    const id = paymentIdInput.value || null;
    const name = paymentNameInput.value.trim();
    const sum = parseFloat(paymentSumInput.value);
    const date = paymentDateInput.value;
    const category = paymentCategorySelect.value;
    const period = paymentPeriodSelect.value;
    if(!name || !date || isNaN(sum)) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
    const color = getSelectedColor();

    savePayment({id, name, sum, date, category, period, color});
    closeModal(paymentModal);
    buildCalendar();
    updateStats();
    // –û—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
    searchInput.value = '';
    searchResults.innerHTML = '';
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–Ω–æ–ø–∫–µ "X"
  modalCloseBtns.forEach(btn => {
    btn.addEventListener('click', e => {
      const modal = e.target.closest('.overlay');
      closeModal(modal);
    });
  });

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ—Å—è—Ü–µ–≤
  prevMonthBtn.addEventListener('click', () => {
    if(viewMonth === 0) {
      viewMonth = 11;
      viewYear--;
    } else {
      viewMonth--;
    }
    buildCalendar();
  });
  nextMonthBtn.addEventListener('click', () => {
    if(viewMonth === 11) {
      viewMonth = 0;
      viewYear++;
    } else {
      viewMonth++;
    }
    buildCalendar();
  });

  // –û—Ç–∫—Ä—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "+"
  addPaymentBtn.addEventListener('click', () => openAddPayment());

  // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
  [paymentModal, dayViewModal].forEach(modal => {
    modal.addEventListener('click', e => {
      if(e.target === modal) closeModal(modal);
    });
  });

  // –ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–µ–π
  searchInput.addEventListener('input', () => {
    const term = searchInput.value.trim().toLowerCase();
    searchResults.innerHTML = '';
    if(term.length < 2) return;
    const results = payments.filter(p => p.name.toLowerCase().includes(term));
    if(results.length === 0) {
      const li = document.createElement('li');
      li.textContent = '–ü–ª–∞—Ç–µ–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
      searchResults.appendChild(li);
      return;
    }
    results.forEach(p => {
      const li = document.createElement('li');
      li.textContent = `${p.name} ‚Äî ${p.sum.toLocaleString('ru-RU', {style:'currency', currency:'RUB', minimumFractionDigits: 2})} (${capitalize(p.category)})`;
      li.tabIndex = 0;
      li.setAttribute('role', 'option');
      li.addEventListener('click', () => {
        const date = parseDate(p.date);
        if(date) {
          viewYear = date.getFullYear();
          viewMonth = date.getMonth();
          buildCalendar();
          openDayView(date);
        }
        searchInput.value = '';
        searchResults.innerHTML = '';
      });
      li.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          li.click();
        }
      });
      searchResults.appendChild(li);
    });
  });

  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  function updateStats() {
    const sums = {};
    for (const cat in CATEGORY_COLORS) {
      sums[cat] = 0;
    }
    payments.forEach(p => {
      if(sums[p.category] !== undefined) {
        sums[p.category] += Number(p.sum);
      }
    });
    statsEl.innerHTML = '<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>';
    for(const cat in sums) {
      if(sums[cat] === 0) continue;
      const bar = document.createElement('div');
      bar.className = 'stat-bar';

      const label = document.createElement('div');
      label.className = 'stat-label';
      label.textContent = capitalize(cat);
      bar.appendChild(label);

      const value = document.createElement('div');
      value.className = 'stat-value';
      value.textContent = sums[cat].toLocaleString('ru-RU', {style:'currency', currency:'RUB', minimumFractionDigits: 2});
      bar.appendChild(value);

      const colorMark = document.createElement('div');
      colorMark.className = 'stat-color';
      colorMark.style.backgroundColor = CATEGORY_COLORS[cat];
      bar.appendChild(colorMark);

      statsEl.appendChild(bar);
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤ –≤—ã–±–æ—Ä–∞
  buildColorPicker();

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  loadPayments();
  buildCalendar();
  updateStats();

  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –Ω–µ —Ä–µ–∞–ª–∏–∑—É—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ HTML ‚Äî –Ω—É–∂–Ω–æ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞

  // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–æ—Å—Ç–æ –≤ JSON) ‚Äî –¥–æ–±–∞–≤–∏–º –∫–Ω–æ–ø–∫—É –≤ —Ñ—É—Ç–µ—Ä (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –Ω–æ –Ω–µ –≤ –¢–ó ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)

  // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ (Esc –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫–∏)
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape') {
      if(!paymentModal.hidden) closeModal(paymentModal);
      if(!dayViewModal.hidden) closeModal(dayViewModal);
      searchResults.innerHTML = '';
    }
  });

})();
</script>
</body>
</html>
