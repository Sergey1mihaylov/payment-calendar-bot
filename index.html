<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Календарь платежей</title>

<style>
/* ===========================
   СТИЛЬ iOS + ТЁМНЫЙ ГРАДИЕНТ ФОН (вариант D)
   =========================== */
html, body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, SF Pro Text, San Francisco, Helvetica Neue, Arial, sans-serif;
    background: radial-gradient(circle at 20% 20%, #0a0a0f, #0d0f24 35%, #0c0c18 70%, #05050a 100%);
    height: 100%;
    color: #fff;
    overflow: hidden;
}

/* Контейнер */
#app {
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Заголовок */
.header {
    text-align: center;
    padding: 15px 0;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
}

/* Календарная сетка */
.calendar {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    padding: 10px;
}

.day {
    position: relative;
    aspect-ratio: 1 / 1;
    border-radius: 12px;
    font-size: 14px;
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
    padding: 6px;
    cursor: pointer;
    user-select: none;
    transition: transform .15s ease;
}

.day:hover {
    transform: scale(1.03);
}

.day-number {
    z-index: 3;
    pointer-events: none;
}

.today {
    outline: 2px solid #ffffffaa;
    outline-offset: -2px;
}

/* Закрашенная ячейка */
.colored {
    color: #fff !important;
}

/* Нижняя панель */
.bottom-bar {
    padding: 15px;
    display: flex;
    justify-content: center;
}

.add-btn {
    background: #0a84ff;
    width: 60px;
    height: 60px;
    border-radius: 30px;
    color: #fff;
    border: none;
    font-size: 36px;
    line-height: 0;
    cursor: pointer;
    transition: background .2s;
}

.add-btn:hover {
    background: #006be6;
}

/* Модалки */
.modal-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    backdrop-filter: blur(12px);
    background: rgba(0, 0, 0, 0.35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
}

.modal {
    width: 90%;
    max-height: 80%;
    overflow-y: auto;
    background: rgba(25, 25, 35, 0.85);
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, .5);
}

.modal h2 {
    margin-top: 0;
    color: #fff;
}

input, select {
    width: 100%;
    background: rgba(255,255,255,0.08);
    border: none;
    color: #fff;
    padding: 12px;
    border-radius: 12px;
    margin-top: 8px;
    margin-bottom: 12px;
}

.check-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn {
    background: #0a84ff;
    border: none;
    padding: 12px 20px;
    border-radius: 12px;
    color: #fff;
    margin-top: 10px;
    width: 100%;
    text-align: center;
}

.btn-danger {
    background: #ff453a;
    margin-top: 10px;
}

.close-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 18px;
    float: right;
}

/* Стиль списков */
.payment-item {
    padding: 10px;
    border-bottom: 1px solid #ffffff18;
}

.payment-total {
    text-align: right;
    padding-top: 10px;
    font-weight: 600;
}

/* Экспорт / импорт */
.export-btn, .import-btn {
    width: 48%;
}

#fileInput { display:none; }
</style>
</head>
<body>
<div id="app">

    <div class="header">
        <span id="monthLabel"></span>
    </div>

    <div id="calendar" class="calendar"></div>

    <div class="bottom-bar">
        <button class="add-btn" id="openAdd">+</button>
    </div>
</div>

<!-- Модал: добавление -->
<div class="modal-bg" id="addModalBg">
    <div class="modal">
        <button class="close-btn" onclick="closeAdd()">✕</button>
        <h2 id="addTitle">Добавить платёж</h2>

        <input id="payName" placeholder="Название платежа">
        <input id="paySum" placeholder="Сумма" type="number">

        <label>Дата</label>
        <input id="payDate" type="date">

        <label>Категория</label>
        <select id="payCat">
            <option value="mortgage">Ипотека</option>
            <option value="subs">Подписки</option>
            <option value="credit">Кредит</option>
            <option value="mobile">Связь</option>
            <option value="utilities">Коммуналка</option>
            <option value="other">Другое</option>
        </select>

        <label>Периодичность</label>
        <select id="payRepeat">
            <option value="once">Разово</option>
            <option value="start">Первый день месяца</option>
            <option value="end">Последний день месяца</option>
            <option value="30">Каждые 30 дней</option>
        </select>

        <button class="btn" onclick="savePayment()">Сохранить</button>
        <button class="btn-danger" id="delBtn" style="display:none" onclick="deletePayment()">Удалить</button>

        <button class="btn export-btn" onclick="exportJSON()">Экспорт</button>
        <button class="btn import-btn" onclick="document.getElementById('fileInput').click()">Импорт</button>
        <input id="fileInput" type="file" accept="application/json" onchange="importJSON(event)">
    </div>
</div>

<!-- Модал: день -->
<div class="modal-bg" id="dayModalBg">
    <div class="modal">
        <button class="close-btn" onclick="closeDay()">✕</button>
        <h2 id="dayTitle"></h2>
        <div id="dayList"></div>
        <div class="payment-total" id="dayTotal"></div>
    </div>
</div>

<script>
/* =======================================
   ДАННЫЕ + ЛОКАЛЬНОЕ ХРАНЕНИЕ
======================================= */
let payments = JSON.parse(localStorage.getItem("payments") || "[]");
let editingId = null;

const catColors = {
    mortgage: "#ff3b30",
    subs: "#ff9500",
    credit: "#007aff",
    mobile: "#30b6ff",
    utilities: "#ffd60a",
    other: "#ff2d55"
};

/* =======================================
    ОТРИСОВКА КАЛЕНДАРЯ
======================================= */
let current = new Date();

function renderCalendar() {
    const calendar = document.getElementById("calendar");
    calendar.innerHTML = "";

    const monthLabel = document.getElementById("monthLabel");
    const year = current.getFullYear();
    const month = current.getMonth();

    monthLabel.textContent = current.toLocaleString("ru-RU", { month: "long", year: "numeric" });

    const first = new Date(year, month, 1).getDay() || 7;
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    for (let i = 1; i < first; i++) {
        calendar.appendChild(document.createElement("div"));
    }

    for (let d = 1; d <= daysInMonth; d++) {
        const cell = document.createElement("div");
        cell.className = "day";
        const label = document.createElement("div");
        label.className = "day-number";
        label.textContent = d;
        cell.appendChild(label);

        let dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        let items = payments.filter(p => p.date === dateStr);

        if (items.length > 0) {
            let max = items.reduce((a,b)=> Number(a.sum)>Number(b.sum)?a:b);
            let color = catColors[max.cat];
            cell.style.background = color;
            cell.classList.add("colored");
        }

        if (d === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
            cell.classList.add("today");
        }

        cell.onclick = () => openDay(dateStr);

        calendar.appendChild(cell);
    }
}

/* =======================================
    ОКНО ДНЯ
======================================= */
function openDay(dateStr) {
    const bg = document.getElementById("dayModalBg");
    const title = document.getElementById("dayTitle");
    const list = document.getElementById("dayList");
    const total = document.getElementById("dayTotal");

    list.innerHTML = "";
    total.innerHTML = "";

    let items = payments.filter(p => p.date === dateStr);
    title.textContent = dateStr.split("-").reverse().join(".");

    let sum = 0;

    items.forEach(p => {
        let div = document.createElement("div");
        div.className = "payment-item";
        div.innerHTML = `
            <b>${p.name}</b><br>
            ${p.sum} ₽ — ${p.cat}
            <br><button class="btn" onclick="editPayment('${p.id}')">Открыть</button>
        `;
        sum += Number(p.sum);
        list.appendChild(div);
    });

    if (items.length)
        total.textContent = "Итого: " + sum + " ₽";

    bg.style.display = "flex";
}

function closeDay() {
    document.getElementById("dayModalBg").style.display = "none";
}

/* =======================================
    ДОБАВЛЕНИЕ / РЕДАКТИРОВАНИЕ
======================================= */
document.getElementById("openAdd").onclick = () => openAdd();

function openAdd(date=null) {
    editingId = null;
    document.getElementById("addTitle").textContent = "Добавить платёж";
    document.getElementById("delBtn").style.display = "none";

    document.getElementById("payName").value = "";
    document.getElementById("paySum").value = "";
    document.getElementById("payDate").value = date || new Date().toISOString().split("T")[0];
    document.getElementById("payCat").value = "mortgage";
    document.getElementById("payRepeat").value = "once";

    document.getElementById("addModalBg").style.display = "flex";
}

function editPayment(id) {
    let p = payments.find(x=>x.id === id);
    if (!p) return;

    editingId = id;

    document.getElementById("addTitle").textContent = "Изменить платёж";
    document.getElementById("delBtn").style.display = "block";

    document.getElementById("payName").value = p.name;
    document.getElementById("paySum").value = p.sum;
    document.getElementById("payDate").value = p.date;
    document.getElementById("payCat").value = p.cat;
    document.getElementById("payRepeat").value = p.repeat;

    closeDay();
    document.getElementById("addModalBg").style.display = "flex";
}

function closeAdd() {
    document.getElementById("addModalBg").style.display = "none";
}

function savePayment() {
    let name = payName.value.trim();
    let sum = paySum.value.trim();
    let date = payDate.value;
    let cat = payCat.value;
    let repeat = payRepeat.value;

    if (!name || !sum || !date) return;

    if (editingId) {
        let p = payments.find(x=>x.id === editingId);
        p.name = name;
        p.sum = sum;
        p.date = date;
        p.cat = cat;
        p.repeat = repeat;
    } else {
        let id = "p" + Date.now();
        payments.push({ id, name, sum, date, cat, repeat });
        generateSeries(id);
    }

    localStorage.setItem("payments", JSON.stringify(payments));
    closeAdd();
    renderCalendar();
}

/* =======================================
    СЕРИИ: 1 ЧИСЛО / ПОСЛЕДНИЙ ДЕНЬ / +30
======================================= */
function generateSeries(id) {
    let p = payments.find(x=>x.id === id);
    if (!p) return;

    let count = 24; 
    let base = new Date(p.date);

    for (let i = 0; i < count; i++) {
        let next;

        if (p.repeat === "start") {
            let y = base.getFullYear();
            let m = base.getMonth() + i + 1;
            next = new Date(y, m, 1);
        }

        else if (p.repeat === "end") {
            let y = base.getFullYear();
            let m = base.getMonth() + i + 1;
            next = new Date(y, m + 1, 0);
        }

        else if (p.repeat === "30") {
            next = new Date(base);
            next.setDate(next.getDate() + (30 * (i + 1)));
        }

        else continue;

        let date = next.toISOString().split("T")[0];

        payments.push({
            id: "p" + Date.now() + Math.random(),
            name: p.name,
            sum: p.sum,
            date,
            cat: p.cat,
            repeat: p.repeat
        });
    }

    localStorage.setItem("payments", JSON.stringify(payments));
    renderCalendar();
}

/* =======================================
    УДАЛЕНИЕ: УДАЛЯЕМ ТОЛЬКО БУДУЩИЕ
======================================= */
function deletePayment() {
    let p = payments.find(x=>x.id === editingId);
    if (!p) return;

    let base = p.date;

    payments = payments.filter(x => {
        return !(x.name === p.name &&
                 x.sum === p.sum &&
                 x.cat === p.cat &&
                 x.repeat === p.repeat &&
                 x.date > base);
    });

    payments = payments.filter(x => x.id !== editingId);

    localStorage.setItem("payments", JSON.stringify(payments));

    closeAdd();
    renderCalendar();
}

/* =======================================
    ЭКСПОРТ / ИМПОРТ JSON
======================================= */
function exportJSON() {
    let data = {
        payments
    };

    let blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    let url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    a.download = "payments-backup.json";
    a.click();
}

function importJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data = JSON.parse(e.target.result);
            payments = data.payments || [];
            localStorage.setItem("payments", JSON.stringify(payments));
            renderCalendar();
        } catch (err) {
            alert("Ошибка JSON");
        }
    };
    reader.readAsText(file);
}

/* =======================================
    ЗАПУСК
======================================= */
document.addEventListener("DOMContentLoaded", () => {
    renderCalendar();
});
</script>
</body>
</html>
