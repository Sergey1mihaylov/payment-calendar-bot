<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>iOS style Календарь платежей</title>
<style>
  *{box-sizing:border-box;}
  body {
    margin:0; min-height:100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: linear-gradient(180deg, #03040a 0%, #071125 40%, #08121a 100%);
    color: #e6eef8;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    display: flex;
    justify-content: center;
    padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
  }
  #app {
    width: 100%;
    max-width: 460px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  header {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    padding: 8px 0 2px;
  }
  #monthLabel {
    font-weight: 900;
    font-size: 1.3rem;
    letter-spacing: 0.05em;
  }
  button.nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: #0a84ff;
    font-size: 2.2rem;
    font-weight: 700;
    cursor: pointer;
    user-select:none;
    width: 40px;
    height: 40px;
  }
  button#prev {
    left: 0;
  }
  button#next {
    right: 0;
  }
  button.nav:active {
    transform: translateY(-50%) scale(0.9);
  }
  .weekdays {
    display: grid;
    grid-template-columns: repeat(7,1fr);
    gap: 8px;
    color: #a8b8d6;
    font-weight: 700;
    user-select:none;
  }
  .weekday {
    text-align: center;
    font-size: 0.88rem;
  }
  #calendar {
    display: grid;
    grid-template-columns: repeat(7,1fr);
    gap: 8px;
  }
  .day {
    aspect-ratio: 1 / 1;
    border-radius: 14px;
    display: flex;
    justify-content: flex-start;
    align-items: flex-start;
    padding: 10px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    user-select:none;
    position: relative;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }
  .day.empty {
    opacity: 0.12;
    cursor: default;
  }
  .day:hover:not(.empty) {
    background-color: rgba(10, 132, 255, 0.15);
  }
  .day.selected {
    background: linear-gradient(135deg, #0a84ff, #5ac8fa);
    color: white;
    box-shadow:
      0 0 0 3px rgba(10,132,255,0.8),
      0 8px 15px rgba(10,132,255,0.4);
  }
  .day.today {
    border: 2px solid #0a84ff;
  }
  .day .date-num {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    line-height: 36px;
    text-align: center;
    pointer-events:none;
  }
  .day.has-payments {
    background-color: rgba(10, 132, 255, 0.12);
  }
  #fab {
    position: fixed;
    right: 20px;
    bottom: 20px;
    background: #0a84ff;
    border: none;
    color: white;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    font-size: 34px;
    font-weight: 700;
    cursor: pointer;
    box-shadow:
      0 10px 30px rgba(10,132,255,0.6);
    user-select:none;
    transition: transform 0.2s ease;
    z-index: 1000;
  }
  #fab:active {
    transform: scale(0.92);
  }
  .overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1500;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .overlay.show {
    opacity: 1;
    pointer-events: auto;
  }
  .modal {
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius: 18px;
    padding: 20px;
    width: 100%;
    max-width: 420px;
    color: #e6eef8;
    box-shadow: 0 12px 36px rgba(10,132,255,0.3);
    position: relative;
  }
  .modal h2 {
    margin-top: 0;
    font-weight: 800;
    font-size: 1.2rem;
    text-align: center;
  }
  .modal button.close {
    position: absolute;
    right: 16px;
    top: 16px;
    background: none;
    border: none;
    font-size: 24px;
    color: #0a84ff;
    cursor: pointer;
    user-select:none;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin-top: 12px;
  }
  label {
    font-weight: 700;
    font-size: 0.9rem;
  }
  input[type="text"],
  input[type="number"],
  input[type="date"],
  select {
    border-radius: 12px;
    border: none;
    padding: 10px 14px;
    font-size: 1rem;
    background: rgba(255,255,255,0.07);
    color: #e6eef8;
    outline-offset: 2px;
    outline-color: #0a84ff;
    outline-style: solid;
    outline-width: 0;
    transition: outline-width 0.2s ease;
  }
  input[type="text"]:focus,
  input[type="number"]:focus,
  input[type="date"]:focus,
  select:focus {
    outline-width: 2px;
  }
  .row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .radio-group label {
    cursor: pointer;
    user-select:none;
    font-weight: 600;
  }
  input[type="radio"] {
    margin-right: 6px;
  }
  input[type="checkbox"] {
    margin-right: 8px;
  }
  button.btn {
    background: #0a84ff;
    border: none;
    padding: 12px 16px;
    font-weight: 700;
    color: white;
    font-size: 1rem;
    border-radius: 14px;
    cursor: pointer;
    box-shadow:
      0 6px 18px rgba(10,132,255,0.6);
    user-select:none;
    transition: background-color 0.3s ease;
  }
  button.btn:hover {
    background-color: #147aff;
  }
  button.btn:active {
    background-color: #0a64d8;
  }
  button.btn.secondary {
    background: transparent;
    border: 1.5px solid #0a84ff;
    color: #0a84ff;
    box-shadow: none;
  }
  button.btn.secondary:hover {
    background: rgba(10,132,255,0.15);
  }
  .color-picker {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .color-btn {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }
  .color-btn.selected {
    border-color: white;
    transform: translateY(-2px);
  }
  #dayPaymentsList {
    max-height: 280px;
    overflow-y: auto;
    margin-top: 8px;
  }
  .payment-item {
    background: rgba(255,255,255,0.06);
    border-radius: 14px;
    padding: 12px 16px;
    margin-bottom: 8px;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select:none;
  }
  .payment-item .category-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.8rem;
    user-select:none;
  }
  #dayTotal {
    margin-top: 12px;
    font-weight: 900;
    font-size: 1.1rem;
    text-align: right;
    color: #0a84ff;
    user-select:none;
  }
  footer {
    font-size: 0.85rem;
    color: #8a9bb8;
    text-align: center;
    margin-top: 12px;
    user-select:none;
  }
  @media (max-width: 360px) {
    #app {
      max-width: 100%;
    }
    button.nav {
      font-size: 1.8rem;
      width: 34px;
      height: 34px;
    }
    #fab {
      width: 48px;
      height: 48px;
      font-size: 28px;
    }
  }
</style>
</head>
<body>
  <div id="app" role="application" aria-label="Календарь платежей">
    <header>
      <button class="nav" id="prev" aria-label="Предыдущий месяц">&lsaquo;</button>
      <h1 id="monthLabel" aria-live="polite">Январь 2024</h1>
      <button class="nav" id="next" aria-label="Следующий месяц">&rsaquo;</button>
    </header>

    <div class="weekdays" aria-hidden="true">
      <div class="weekday">Пн</div>
      <div class="weekday">Вт</div>
      <div class="weekday">Ср</div>
      <div class="weekday">Чт</div>
      <div class="weekday">Пт</div>
      <div class="weekday">Сб</div>
      <div class="weekday">Вс</div>
    </div>

    <div id="calendar" role="grid" aria-label="Календарь"></div>

    <button id="fab" aria-label="Добавить платеж">+</button>

    <footer>Данные хранятся локально (localStorage). Экспорт и импорт доступны.</footer>
  </div>

  <!-- Add/Edit modal -->
  <div class="overlay" id="modalAdd" role="dialog" aria-modal="true" aria-labelledby="modalAddTitle" tabindex="-1" hidden>
    <div class="modal">
      <button class="close" aria-label="Закрыть">&times;</button>
      <h2 id="modalAddTitle">Добавить платеж</h2>
      <form id="formAdd">
        <input type="hidden" id="paymentId" />
        <label for="paymentName">Название</label>
        <input id="paymentName" type="text" maxlength="40" required placeholder="Ипотека, подписка..." autocomplete="off" />

        <label for="paymentSum">Сумма (₽)</label>
        <input id="paymentSum" type="number" min="0" step="0.01" required placeholder="10000" autocomplete="off" />

        <label for="paymentDate">Дата</label>
        <input id="paymentDate" type="date" required />

        <label for="paymentCategory">Категория</label>
        <select id="paymentCategory" required>
          <option value="ипотека">Ипотека</option>
          <option value="подписки">Подписки</option>
          <option value="кредит">Кредит</option>
          <option value="связь">Связь</option>
          <option value="коммуналка">Коммуналка</option>
          <option value="другое">Другое</option>
        </select>

        <label>
          <input type="checkbox" id="paymentAutoSeries" />
          Автосерия (каждый месяц)
        </label>

        <div style="display:flex; gap:10px; margin-top: 10px; flex-wrap: wrap;">
          <button type="submit" class="btn" style="flex-grow:1;">Сохранить</button>
          <button type="button" class="btn secondary" id="btnDelete" style="flex-grow:1; color:#ff7a7a; border-color:#ff7a7a; display:none;">Удалить</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Day payments modal -->
  <div class="overlay" id="modalDay" role="dialog" aria-modal="true" aria-labelledby="modalDayTitle" tabindex="-1" hidden>
    <div class="modal">
      <button class="close" aria-label="Закрыть">&times;</button>
      <h2 id="modalDayTitle">Платежи</h2>
      <div id="dayPaymentsList"></div>
      <div id="dayTotal"></div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const CAT_COLORS = {
    "ипотека": "#ff4d4f",
    "подписки": "#ff8c3b",
    "кредит": "#2f80ed",
    "связь": "#4cc9f0",
    "коммуналка": "#ffd60a",
    "другое": "#9e9e9e"
  };

  const monthLabel = document.getElementById('monthLabel');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const calendarEl = document.getElementById('calendar');
  const fab = document.getElementById('fab');

  const modalAdd = document.getElementById('modalAdd');
  const modalDay = document.getElementById('modalDay');
  const dayPaymentsList = document.getElementById('dayPaymentsList');
  const dayTotal = document.getElementById('dayTotal');

  const formAdd = document.getElementById('formAdd');
  const paymentId = document.getElementById('paymentId');
  const paymentName = document.getElementById('paymentName');
  const paymentSum = document.getElementById('paymentSum');
  const paymentDate = document.getElementById('paymentDate');
  const paymentCategory = document.getElementById('paymentCategory');
  const paymentAutoSeries = document.getElementById('paymentAutoSeries');
  const btnDelete = document.getElementById('btnDelete');

  let currentYear, currentMonth;
  let payments = [];
  let selectedDateStr = null;

  const generateId = () => 'p' + Math.random().toString(36).slice(2, 10);

  function formatDate(date) {
    const y = date.getFullYear();
    const m = (date.getMonth() + 1).toString().padStart(2,'0');
    const d = date.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  function parseDate(str) {
    return new Date(str + 'T00:00:00');
  }

  function daysInMonth(year, month) {
    return new Date(year, month + 1, 0).getDate();
  }

  function weekdayISO(date) {
    let wd = date.getDay();
    return wd === 0 ? 7 : wd;
  }

  const MONTH_NAMES = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];

  function savePayments() {
    localStorage.setItem('payments', JSON.stringify(payments));
  }

  function loadPayments() {
    const data = localStorage.getItem('payments');
    payments = data ? JSON.parse(data) : [];
  }

  function getPaymentsForDate(dateStr) {
    return payments.filter(p => p.date === dateStr);
  }

  function getPaymentsForMonth(year, month) {
    return payments.filter(p => {
      const d = parseDate(p.date);
      return d.getFullYear() === year && d.getMonth() === month;
    });
  }

  function updateMonthLabel() {
    monthLabel.textContent = `${MONTH_NAMES[currentMonth]} ${currentYear}`;
  }

  function clearSelected() {
    if (!selectedDateStr) return;
    const prev = calendarEl.querySelector(`.day[data-date="${selectedDateStr}"]`);
    if (prev) prev.classList.remove('selected');
    selectedDateStr = null;
  }

  function renderCalendar() {
    calendarEl.innerHTML = '';
    updateMonthLabel();

    const firstDay = new Date(currentYear, currentMonth, 1);
    const firstWeekday = weekdayISO(firstDay); // 1(Пн) - 7(Вс)
    const totalDays = daysInMonth(currentYear, currentMonth);

    // Пустые клетки перед первым числом (если первый
      // Пустые клетки перед первым числом (если первый день не понедельник)
    for(let i=1; i < firstWeekday; i++){
      const emptyCell = document.createElement('div');
      emptyCell.classList.add('day','empty');
      calendarEl.appendChild(emptyCell);
    }

    // Дни месяца
    const todayStr = formatDate(new Date());
    for(let day=1; day <= totalDays; day++){
      const dateStr = `${currentYear}-${(currentMonth+1).toString().padStart(2,'0')}-${day.toString().padStart(2,'0')}`;
      const dayCell = document.createElement('div');
      dayCell.classList.add('day');
      dayCell.setAttribute('data-date', dateStr);
      dayCell.setAttribute('role', 'gridcell');
      dayCell.setAttribute('tabindex', '0');
      dayCell.innerHTML = `<div class="date-num">${day}</div>`;

      // Подсветка сегодня
      if(dateStr === todayStr) dayCell.classList.add('today');

      // Есть ли платежи на этот день
      const pays = getPaymentsForDate(dateStr);
      if(pays.length) dayCell.classList.add('has-payments');

      // Выделение выбранного дня
      if(dateStr === selectedDateStr) dayCell.classList.add('selected');

      dayCell.addEventListener('click', () => openDayModal(dateStr));
      dayCell.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openDayModal(dateStr);
        }
      });

      calendarEl.appendChild(dayCell);
    }
  }

  function openAddModal(dateStr = null, payment = null) {
    if(payment){
      paymentId.value = payment.id;
      paymentName.value = payment.name;
      paymentSum.value = payment.sum;
      paymentDate.value = payment.date;
      paymentCategory.value = payment.category;
      paymentAutoSeries.checked = payment.autoSeries || false;
      btnDelete.style.display = 'inline-block';
    } else {
      paymentId.value = '';
      paymentName.value = '';
      paymentSum.value = '';
      paymentDate.value = dateStr || formatDate(new Date());
      paymentCategory.value = 'ипотека';
      paymentAutoSeries.checked = false;
      btnDelete.style.display = 'none';
    }
    modalAdd.classList.add('show');
    modalAdd.removeAttribute('hidden');
    paymentName.focus();
  }

  function closeAddModal() {
    modalAdd.classList.remove('show');
    modalAdd.setAttribute('hidden', '');
  }

  function openDayModal(dateStr) {
    selectedDateStr = dateStr;
    renderCalendar();

    const pays = getPaymentsForDate(dateStr);
    dayPaymentsList.innerHTML = '';

    if(pays.length === 0){
      dayPaymentsList.innerHTML = `<p style="text-align:center; font-weight:600; opacity:0.5;">Нет платежей</p>`;
    } else {
      pays.forEach(p => {
        const el = document.createElement('div');
        el.className = 'payment-item';
        el.innerHTML = `
          <span>${p.name}</span>
          <span style="font-weight: 900;">${Number(p.sum).toLocaleString('ru-RU', {minimumFractionDigits:2})} ₽</span>
        `;
        dayPaymentsList.appendChild(el);
      });
    }
    const total = pays.reduce((acc, p) => acc + Number(p.sum), 0);
    dayTotal.textContent = `Итого: ${total.toLocaleString('ru-RU', {minimumFractionDigits:2})} ₽`;

    modalDay.classList.add('show');
    modalDay.removeAttribute('hidden');
  }

  function closeDayModal() {
    modalDay.classList.remove('show');
    modalDay.setAttribute('hidden', '');
    clearSelected();
  }

  function addOrUpdatePayment(e) {
    e.preventDefault();
    const id = paymentId.value;
    const name = paymentName.value.trim();
    const sum = parseFloat(paymentSum.value);
    const date = paymentDate.value;
    const category = paymentCategory.value;
    const autoSeries = paymentAutoSeries.checked;

    if(!name || isNaN(sum) || sum < 0 || !date) return;

    if(id){
      // Update existing
      const idx = payments.findIndex(p => p.id === id);
      if(idx !== -1){
        payments[idx] = {id, name, sum, date, category, autoSeries};
      }
    } else {
      // Add new
      payments.push({id: generateId(), name, sum, date, category, autoSeries});
    }
    savePayments();
    closeAddModal();
    renderCalendar();
  }

  function deletePayment() {
    const id = paymentId.value;
    if(!id) return;
    payments = payments.filter(p => p.id !== id);
    savePayments();
    closeAddModal();
    renderCalendar();
  }

  function prevMonth() {
    if(currentMonth === 0){
      currentMonth = 11;
      currentYear--;
    } else {
      currentMonth--;
    }
    clearSelected();
    renderCalendar();
  }

  function nextMonth() {
    if(currentMonth === 11){
      currentMonth = 0;
      currentYear++;
    } else {
      currentMonth++;
    }
    clearSelected();
    renderCalendar();
  }

  function init() {
    loadPayments();
    const now = new Date();
    currentYear = now.getFullYear();
    currentMonth = now.getMonth();
    renderCalendar();
  }

  // Слушатели
  prevBtn.addEventListener('click', prevMonth);
  nextBtn.addEventListener('click', nextMonth);
  fab.addEventListener('click', () => openAddModal());

  // Закрытие модалок
  modalAdd.querySelector('.close').addEventListener('click', closeAddModal);
  modalDay.querySelector('.close').addEventListener('click', closeDayModal);

  formAdd.addEventListener('submit', addOrUpdatePayment);
  btnDelete.addEventListener('click', deletePayment);

  // Клавиши Esc закрывают модалки
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape'){
      if(modalAdd.classList.contains('show')) closeAddModal();
      else if(modalDay.classList.contains('show')) closeDayModal();
    }
  });

  init();

})();
</script>
</body>
</html>
