<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Календарь платежей — iOS style (финал)</title>
<style>
  /* Системные шрифты */
  body, button, input, select { font-family: -apple-system, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
  :root{
    --radius:14px;
    --primary:#0a84ff;
    --shadow: 0 12px 30px rgba(0,0,0,0.45);
    --glass: rgba(255,255,255,0.04);
  }
  /* Тёмная фон — глубокие абстрактные "обои" */
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 600px at 10% 10%, rgba(44,20,80,0.55), transparent 10%),
    radial-gradient(1000px 500px at 90% 90%, rgba(6,50,62,0.5), transparent 12%),
    linear-gradient(180deg, #03040a 0%, #071125 40%, #08121a 100%);
    color:#e6eef8;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
  #app{max-width:520px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom);gap:10px;}
  header{display:flex;align-items:center;justify-content:center;position:relative;padding:14px 8px 6px;}
  header h1{margin:0;font-size:1.15rem;font-weight:800;letter-spacing:0.01em;color:#f5f8ff}
  .nav-left,.nav-right{position:absolute;top:50%;transform:translateY(-50%);background:transparent;border:0;padding:8px;border-radius:10px;color:var(--primary);cursor:pointer}
  .nav-left{left:8px} .nav-right{right:8px}

  /* Controls */
  .controls{display:flex;gap:8px;justify-content:center;padding:0 12px 6px;}
  .btn {background:var(--primary);color:#fff;border:0;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:transform 200ms;display:inline-flex;gap:8px;align-items:center;}
  .btn:active{transform:translateY(1px)}
  .ghost{background:transparent;color:#dfe9ff;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px}
  .small{padding:8px 10px;border-radius:10px;font-weight:700}

  /* Weekdays */
  .weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:0 6px}
  .weekday{font-weight:800;font-size:0.82rem;text-align:center;padding:6px 4px;color:rgba(200,220,255,0.9);opacity:0.95}

  /* Calendar grid */
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:6px}
  .day{min-height:72px;border-radius:12px;padding:8px 10px 10px 10px;position:relative;overflow:hidden;transition:transform 220ms, background-color 220ms;display:flex;flex-direction:column;justify-content:flex-start;cursor:pointer;background:transparent;color:inherit}
  .day.empty{opacity:0.18;cursor:default;background:transparent}
  .day:hover{transform:translateY(-4px)}
  .num{font-weight:900;z-index:2;width:36px;height:36px;line-height:36px;border-radius:50%;text-align:center;background:transparent;color:inherit}
  .day.today .num{box-shadow:0 10px 30px rgba(10,132,255,0.12);outline:2px solid rgba(255,255,255,0.03)}
  .badge{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.12);color:#fff;padding:4px 8px;border-radius:10px;font-weight:800;font-size:0.8rem}
  .list{margin-top:8px;display:flex;flex-direction:column;gap:6px;z-index:2}
  .chip{display:flex;align-items:center;padding:6px 8px;border-radius:10px;font-weight:800;color:white;font-size:0.9rem;box-shadow:0 6px 14px rgba(0,0,0,0.18);}

  /* Controls: export/import area (footer) */
  .footer-controls{display:flex;gap:8px;justify-content:center;padding:8px}

  #fab{position:fixed;right:18px;bottom:18px;width:58px;height:58px;border-radius:50%;background:var(--primary);color:#fff;font-size:34px;border:0;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);z-index:2000}

  /* Overlay + modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2000;padding:20px}
  .modal{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(8px);border-radius:14px;box-shadow:var(--shadow);width:100%;max-width:520px;max-height:92vh;overflow:auto;padding:16px;position:relative;border:1px solid rgba(255,255,255,0.03)}
  .modal h2{margin:0 0 12px;font-size:1.1rem;font-weight:800;text-align:center;color:#eef6ff}
  .close{position:absolute;right:12px;top:12px;border:0;background:transparent;font-size:22px;color:var(--primary);cursor:pointer}

  form{display:flex;flex-direction:column;gap:8px}
  label{font-weight:800;font-size:0.9rem;color:#eaf4ff}
  input[type=text],input[type=number],input[type=date],select{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eaf4ff;outline:none;font-size:1rem}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .color-picker{display:flex;gap:8px;flex-wrap:wrap}
  .color-btn{width:36px;height:36px;border-radius:8px;border:2px solid transparent;cursor:pointer}
  .color-btn.selected{outline:3px solid rgba(255,255,255,0.04);transform:translateY(-2px)}

  .payment-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
  .payment-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
  .actions{display:flex;gap:6px}

  footer{padding:10px 6px 40px;text-align:center;font-size:0.85rem;color:#cfe6ff;opacity:0.9}

  @media (min-width:420px){ .day{min-height:88px} }
</style>
</head>
<body>
<div id="app" role="application" aria-label="Календарь платежей">
  <header>
    <button class="nav-left" id="prev" aria-label="Предыдущий месяц">&lsaquo;</button>
    <h1 id="monthLabel" aria-live="polite">Календарь</h1>
    <button class="nav-right" id="next" aria-label="Следующий месяц">&rsaquo;</button>
  </header>

  <!-- Weekdays -->
  <div class="weekdays" aria-hidden="false">
    <div class="weekday">Пн</div>
    <div class="weekday">Вт</div>
    <div class="weekday">Ср</div>
    <div class="weekday">Чт</div>
    <div class="weekday">Пт</div>
    <div class="weekday">Сб</div>
    <div class="weekday">Вс</div>
  </div>

  <!-- Calendar grid -->
  <div id="calendar" class="calendar" role="grid" aria-label="Календарь"></div>

  <!-- Floating add -->
  <button id="fab" title="Добавить платеж">+</button>

  <!-- Footer controls: export/import -->
  <div class="footer-controls">
    <button id="exportBtn" class="ghost">Экспорт</button>
    <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
      Импорт
      <input id="importFile" type="file" accept=".json" style="display:none">
    </label>
  </div>

  <footer>Данные хранятся локально (localStorage). Напоминания — через бот/сервер.</footer>
</div>

<!-- Modal: Add/Edit -->
<div id="modalAdd" class="overlay" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addTitle">
    <button class="close" data-close>&times;</button>
    <h2 id="addTitle">Добавить / Редактировать платеж</h2>
    <form id="form">
      <input type="hidden" id="pid">
      <label for="pname">Название</label>
      <input id="pname" type="text" required placeholder="Например, Ипотека">

      <label for="psum">Сумма (₽)</label>
      <input id="psum" type="number" required min="0" step="0.01" placeholder="10000">

      <label for="pdate">Дата</label>
      <input id="pdate" type="date" required>

      <label for="pcat">Категория</label>
      <select id="pcat" required>
        <option value="ипотека">Ипотека</option>
        <option value="подписки">Подписки</option>
        <option value="кредит">Кредит</option>
        <option value="связь">Связь</option>
        <option value="коммуналка">Коммуналка</option>
        <option value="другое">Другое</option>
      </select>

      <label>Периодичность</label>
      <div class="row" id="periodRow">
        <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="period" value="разово" checked> Разово</label>
        <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="period" value="start_month"> 1-е</label>
        <label style="display:flex;align-items:center;gap:8px"><input type="radio" name="period" value="end_month"> посл. день</label>
      </div>

      <label><input type="checkbox" id="autoSeries"> Создать автосерию (24 повтора вперед)</label>

      <label>Цвет метки (по умолчанию — цвет категории)</label>
      <div class="color-picker" id="colorPicker"></div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="saveBtn" type="submit">Сохранить</button>
        <button class="ghost" id="btnAdd30" type="button">+30 дней</button>
        <button class="ghost" id="btnAdd30Auto" type="button">+30 (серия 24)</button>
        <button class="ghost" id="btnDelete" type="button" style="margin-left:auto;color:#ff7a7a">Удалить</button>
      </div>

      <div style="margin-top:8px;font-size:0.9rem;color:#cbdff6">Примечание: суммы видны только в детальном просмотре. Удаление одного платежа серии удаляет последующие записи серии, предыдущие остаются.</div>
    </form>
  </div>
</div>

<!-- Modal: Day view (no auto-open) -->
<div id="modalDay" class="overlay" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dayTitle">
    <button class="close" data-close>&times;</button>
    <h2 id="dayTitle">Платежи</h2>
    <div id="dayList" class="payment-list" style="margin-top:8px"></div>
    <div style="margin-top:12px;text-align:right;font-weight:800;color:#f1f9ff" id="dayTotal"></div>
  </div>
</div>

<script>
(() => {
  'use strict';

  /* ---------- Constants / Colors ---------- */
  const CAT_COLORS = {
    'ипотека': '#ff4d4f',
    'подписки': '#ff8c3b',
    'кредит': '#2f80ed',
    'связь': '#4cc9f0',
    'коммуналка': '#ffd60a',
    'другое': '#ff66b2'
  };
  const SERIES_LENGTH = 24; // 24 months / 24 occurrences

  /* ---------- DOM ---------- */
  const calendarEl = document.getElementById('calendar');
  const monthLabel = document.getElementById('monthLabel');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const fab = document.getElementById('fab');

  const modalAdd = document.getElementById('modalAdd');
  const form = document.getElementById('form');
  const pid = document.getElementById('pid');
  const pname = document.getElementById('pname');
  const psum = document.getElementById('psum');
  const pdate = document.getElementById('pdate');
  const pcat = document.getElementById('pcat');
  const colorPicker = document.getElementById('colorPicker');
  const autoSeriesCheckbox = document.getElementById('autoSeries');
  const btnAdd30 = document.getElementById('btnAdd30');
  const btnAdd30Auto = document.getElementById('btnAdd30Auto');
  const btnDelete = document.getElementById('btnDelete');

  const modalDay = document.getElementById('modalDay');
  const dayTitle = document.getElementById('dayTitle');
  const dayList = document.getElementById('dayList');
  const dayTotal = document.getElementById('dayTotal');

  const exportBtn = document.getElementById('exportBtn');
  const importFile = document.getElementById('importFile');

  /* ---------- State ---------- */
  let today = new Date();
  let viewYear = today.getFullYear();
  let viewMonth = today.getMonth(); // 0-11
  // payments structure:
  // { id, name, sum, date: 'YYYY-MM-DD', category, period: 'разово'|'start_month'|'end_month', color, createdAt, seriesId (opt), seriesIndex (opt) }
  let payments = [];

  /* ---------- Persistence ---------- */
  function load() {
    try {
      const raw = localStorage.getItem('payments_final_v1');
      payments = raw ? JSON.parse(raw) : [];
    } catch (e) {
      payments = [];
    }
  }
  function save() {
    localStorage.setItem('payments_final_v1', JSON.stringify(payments));
  }

  /* ---------- Utils ---------- */
  function uid(){ return '_' + Math.random().toString(36).slice(2,9); }
  function iso(d){ if(!(d instanceof Date)) return ''; const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${y}-${m}-${day}`; }
  function parseISO(s){ if(!s) return null; const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
  function lastDayOfMonth(y,m){ return new Date(y,m+1,0).getDate(); }
  function isSameDate(a,b){ return a && b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function addDays(d,n){ const x=new Date(d.getTime()); x.setDate(x.getDate()+n); return x; }
  function capitalize(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }
  function labelForPeriod(p){ if(p==='разово') return 'Разово'; if(p==='start_month') return '1-е'; if(p==='end_month') return 'Последний'; return p; }

  /* ---------- Payments operations ---------- */
  function paymentsOn(date) {
    const t = iso(date);
    return payments.filter(p => p.date === t);
  }

  /* choose cell color: category with maximum sum on that date */
  function colorForDate(date){
    const list = paymentsOn(date);
    if(!list.length) return null;
    const sums = {};
    list.forEach(p => sums[p.category] = (sums[p.category]||0) + Number(p.sum || 0));
    let max = Object.keys(sums).reduce((a,b) => sums[a] >= sums[b] ? a : b);
    return CAT_COLORS[max] || null;
  }

  /* ---------- Calendar rendering ---------- */
  function renderCalendar(){
    calendarEl.innerHTML = '';
    const first = new Date(viewYear, viewMonth, 1);
    monthLabel.textContent = first.toLocaleDateString('ru-RU', {month:'long', year:'numeric'});

    // Monday-first
    let startWeekDay = first.getDay(); // 0..6 Sun..Sat
    startWeekDay = startWeekDay === 0 ? 7 : startWeekDay;
    const prefix = startWeekDay - 1;
    const daysInMonth = new Date(viewYear, viewMonth+1, 0).getDate();
    const totalCells = 42;

    for(let i=0;i<totalCells;i++){
      const cell = document.createElement('div');
      cell.className = 'day';
      const dayIndex = i - prefix + 1;
      if(dayIndex < 1 || dayIndex > daysInMonth){
        cell.classList.add('empty');
        const num = document.createElement('div'); num.className='num'; num.textContent = '';
        cell.appendChild(num);
      } else {
        const d = new Date(viewYear, viewMonth, dayIndex);
        const num = document.createElement('div'); num.className='num'; num.textContent = dayIndex;
        if(isSameDate(d, new Date())) cell.classList.add('today');

        const list = paymentsOn(d);
        if(list.length){
          // color by max-sum category (no amounts shown)
          const sums = {};
          list.forEach(p=> sums[p.category] = (sums[p.category]||0) + Number(p.sum||0));
          let maxCat = Object.keys(sums).reduce((a,b)=> sums[a]>=sums[b] ? a : b);
          const bg = CAT_COLORS[maxCat] || '#666';
          cell.style.background = bg;
          cell.style.color = '#fff';
          // badge count only
          const badge = document.createElement('div'); badge.className='badge'; badge.textContent = `${list.length}`;
          cell.appendChild(badge);
          // show up to 2 chips with names only (no sums)
          const listDiv = document.createElement('div'); listDiv.className='list';
          list.slice(0,2).forEach(p=>{
            const chip = document.createElement('div'); chip.className='chip';
            chip.style.background = p.color || (CAT_COLORS[p.category] || '#777');
            chip.textContent = p.name;
            listDiv.appendChild(chip);
          });
          cell.appendChild(listDiv);
        } else {
          cell.style.background = 'transparent';
          cell.style.color = '#eaf4ff';
        }

        cell.addEventListener('click', ()=> openDayModal(d));
        cell.appendChild(num);
        cell.dataset.date = iso(d);
      }
      calendarEl.appendChild(cell);
    }
  }

  /* ---------- Modal helpers ---------- */
  function openModal(el){ el.hidden = false; el.style.display = 'flex'; setTimeout(()=> el.style.opacity = 1, 10); }
  function closeModal(el){ el.hidden = true; el.style.display = 'none'; }

  document.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', e => {
    const p = e.target.closest('.overlay'); if(p) closeModal(p);
  }));
  [modalAdd, modalDay].forEach(m=> m.addEventListener('click', e => { if(e.target === m) closeModal(m); }));
  document.addEventListener('keydown', e => { if(e.key === 'Escape'){ closeModal(modalAdd); closeModal(modalDay);} });

  /* ---------- Day modal (detailed) ---------- */
  function openDayModal(date){
    dayTitle.textContent = 'Платежи ' + date.toLocaleDateString('ru-RU', {day:'numeric', month:'long', year:'numeric'});
    dayList.innerHTML = '';
    const list = paymentsOn(date).slice().sort((a,b)=> a.createdAt - b.createdAt);
    if(list.length === 0){
      const empty = document.createElement('div'); empty.className='muted'; empty.textContent = 'Платежи отсутствуют';
      dayList.appendChild(empty); dayTotal.textContent = '';
    } else {
      let total = 0;
      list.forEach(p=>{
        const item = document.createElement('div'); item.className='payment-item';
        const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
        const name = document.createElement('div'); name.textContent = p.name; name.style.fontWeight='800';
        const meta = document.createElement('div'); meta.textContent = `${capitalize(p.category)} · ${labelForPeriod(p.period)}`; meta.style.opacity='0.85'; meta.style.fontSize='0.95rem';
        left.appendChild(name); left.appendChild(meta);

        const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
        const sum = document.createElement('div'); sum.textContent = Number(p.sum).toLocaleString('ru-RU',{style:'currency',currency:'RUB',minimumFractionDigits:2}); sum.style.fontWeight='800';
        const actions = document.createElement('div'); actions.className='actions';

        const edit = document.createElement('button'); edit.className='ghost'; edit.textContent='Ред.'; edit.addEventListener('click', ()=> openEditPayment(p.id));
        const plus30 = document.createElement('button'); plus30.className='ghost'; plus30.textContent='+30д'; plus30.addEventListener('click', ()=>{
          const base = parseISO(p.date); const nd = addDays(base,30);
          const copy = {...p, id: uid(), date: iso(nd), createdAt: Date.now(), seriesId:null, seriesIndex:null};
          payments.push(copy); save(); renderCalendar(); openDayModal(date);
        });
        const del = document.createElement('button'); del.className='ghost'; del.style.color='#ff7a7a'; del.textContent='Удал.'; del.addEventListener('click', ()=> {
          if(confirm(`Удалить "${p.name}" ${p.date}?`)){
            deletePaymentAndFollowing(p.id);
            save(); renderCalendar(); openDayModal(date);
          }
        });

        actions.appendChild(edit); actions.appendChild(plus30); actions.appendChild(del);
        right.appendChild(sum); right.appendChild(actions);

        item.appendChild(left); item.appendChild(right);
        dayList.appendChild(item);
        total += Number(p.sum || 0);
      });
      dayTotal.textContent = 'Итого: ' + total.toLocaleString('ru-RU',{style:'currency',currency:'RUB',minimumFractionDigits:2});
    }
    openModal(modalDay);
  }

  /* ---------- Add / Edit ---------- */
  function openNewPayment(defaultDate){
    pid.value = '';
    pname.value = '';
    psum.value = '';
    pdate.value = defaultDate ? iso(defaultDate) : iso(new Date());
    pcat.value = 'подписки';
    buildColorPicker();
    selectColorByCategory(pcat.value);
    autoSeriesCheckbox.checked = true;
    btnDelete.style.display = 'none';
    openModal(modalAdd);
  }

  function openEditPayment(id){
    const p = payments.find(x=> x.id === id);
    if(!p) return;
    pid.value = p.id;
    pname.value = p.name;
    psum.value = p.sum;
    pdate.value = p.date;
    pcat.value = p.category;
    buildColorPicker();
    selectColorByColor(p.color);
    // set period radio
    const node = document.querySelector(`input[name="period"][value="${p.period}"]`);
    if(node) node.checked = true;
    autoSeriesCheckbox.checked = false;
    btnDelete.style.display = 'inline-block';
    openModal(modalAdd);
  }

  // Color picker
  function buildColorPicker(){
    colorPicker.innerHTML = '';
    for(const key of Object.keys(CAT_COLORS)){
      const btn = document.createElement('button'); btn.className='color-btn'; btn.title = capitalize(key); btn.style.background = CAT_COLORS[key];
      btn.dataset.cat = key; btn.dataset.color = CAT_COLORS[key];
      btn.addEventListener('click', ()=> {
        document.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('selected'));
        btn.classList.add('selected');
      });
      colorPicker.appendChild(btn);
    }
  }
  function selectColorByCategory(cat){
    const b = Array.from(colorPicker.children).find(x=> x.dataset.cat === cat);
    if(b){ document.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }
  }
  function selectColorByColor(color){
    const b = Array.from(colorPicker.children).find(x=> x.dataset.color === color);
    if(b){ document.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }
  }
  function getSelectedColor(){ const s = colorPicker.querySelector('.color-btn.selected'); return s ? s.dataset.color : (CAT_COLORS[pcat.value] || '#777'); }

  // Save
  form.addEventListener('submit', e => {
    e.preventDefault();
    const data = {
      id: pid.value || uid(),
      name: (pname.value.trim()||'Без названия'),
      sum: Number(psum.value)||0,
      date: pdate.value,
      category: pcat.value,
      period: document.querySelector('input[name="period"]:checked').value,
      color: getSelectedColor(),
      createdAt: Date.now(),
      seriesId: null,
      seriesIndex: null
    };
    const idx = payments.findIndex(x=> x.id === data.id);
    if(idx >= 0){
      payments[idx] = {...payments[idx], ...data};
      save(); renderCalendar(); closeModal(modalAdd);
      return;
    }
    payments.push(data);
    // handle autoseries for start_month / end_month
    if(autoSeriesCheckbox.checked){
      if(data.period === 'start_month') generateStartMonthSeries(data);
      else if(data.period === 'end_month') generateEndMonthSeries(data);
      // if 'разово' and autoSeries checked — do nothing (user can use +30 auto)
    }
    save(); renderCalendar(); closeModal(modalAdd);
  });

  /* ---------- +30 buttons ---------- */
  btnAdd30.addEventListener('click', ()=>{
    const baseDate = pdate.value || iso(new Date());
    const base = parseISO(baseDate);
    const nd = addDays(base,30);
    const data = {
      id: uid(),
      name: (pname.value.trim()||'Без названия'),
      sum: Number(psum.value)||0,
      date: iso(nd),
      category: pcat.value,
      period: 'разово',
      color: getSelectedColor(),
      createdAt: Date.now(),
      seriesId: null,
      seriesIndex: null
    };
    payments.push(data); save(); renderCalendar(); openEditPayment(data.id);
  });

  btnAdd30Auto.addEventListener('click', ()=>{
    const baseDate = pdate.value || iso(new Date());
    const base = parseISO(baseDate);
    const seriesId = uid();
    for(let i=1;i<=SERIES_LENGTH;i++){
      const nd = addDays(base, 30 * i);
      const p = {
        id: uid(),
        name: (pname.value.trim()||'Без названия'),
        sum: Number(psum.value)||0,
        date: iso(nd),
        category: pcat.value,
        period: 'разово',
        color: getSelectedColor(),
        createdAt: Date.now(),
        seriesId,
        seriesIndex: i
      };
      payments.push(p);
    }
    save(); renderCalendar();
  });

  /* ---------- Series generation for start_month / end_month ---------- */
  function generateStartMonthSeries(original){
    const base = parseISO(original.date) || new Date();
    const seriesId = uid();
    original.seriesId = seriesId; original.seriesIndex = 0;
    for(let i=1;i<=SERIES_LENGTH;i++){
      const y = base.getFullYear();
      const m = base.getMonth() + i;
      const d = new Date(y, m, 1);
      const p = {
        id: uid(),
        name: original.name,
        sum: Number(original.sum)||0,
        date: iso(d),
        category: original.category,
        period: 'start_month',
        color: original.color || CAT_COLORS[original.category],
        createdAt: Date.now(),
        seriesId,
        seriesIndex: i
      };
      payments.push(p);
    }
  }

  function generateEndMonthSeries(original){
    const base = parseISO(original.date) || new Date();
    const seriesId = uid();
    original.seriesId = seriesId; original.seriesIndex = 0;
    for(let i=1;i<=SERIES_LENGTH;i++){
      const y = base.getFullYear();
      const m = base.getMonth() + i;
      const year = new Date(y, m, 1).getFullYear();
      const month = new Date(y, m, 1).getMonth();
      const ld = lastDayOfMonth(year, month);
      const d = new Date(year, month, ld);
      const p = {
        id: uid(),
        name: original.name,
        sum: Number(original.sum)||0,
        date: iso(d),
        category: original.category,
        period: 'end_month',
        color: original.color || CAT_COLORS[original.category],
        createdAt: Date.now(),
        seriesId,
        seriesIndex: i
      };
      payments.push(p);
    }
  }

  /* ---------- Deletion: delete payment and following in series only ---------- */
  function deletePaymentAndFollowing(id){
    const p = payments.find(x=> x.id === id);
    if(!p){
      payments = payments.filter(x=> x.id !== id);
      save();
      return;
    }
    if(!p.seriesId){
      payments = payments.filter(x=> x.id !== id);
      save();
      return;
    }
    const sid = p.seriesId;
    const baseDate = parseISO(p.date);
    // remove selected and all with same seriesId and date > baseDate
    payments = payments.filter(x => {
      if(x.id === id) return false;
      if(x.seriesId !== sid) return true;
      const xd = parseISO(x.date);
      if(xd > baseDate) return false; // remove future ones
      return true; // keep past or equal earlier (but equal shouldn't happen)
    });
    save();
  }

  /* ---------- Export / Import ---------- */
  exportBtn.addEventListener('click', () => {
    const payload = {
      exportedAt: new Date().toISOString(),
      payments
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'payments-backup.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  importFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try {
        const data = JSON.parse(evt.target.result);
        if(!data || !Array.isArray(data.payments)) throw new Error('Неверный формат файла');
        if(!confirm('Импорт заменит текущие данные. Продолжить?')) return;
        payments = data.payments;
        save();
        renderCalendar();
        alert('Импорт завершён.');
      } catch(err){
        alert('Ошибка импорта: ' + (err.message || err));
      }
    };
    reader.readAsText(file);
    // reset input
    e.target.value = '';
  });

  /* ---------- Navigation ---------- */
  prevBtn.addEventListener('click', () => {
    if(viewMonth === 0){ viewMonth = 11; viewYear--; } else viewMonth--;
    renderCalendar();
  });
  nextBtn.addEventListener('click', () => {
    if(viewMonth === 11){ viewMonth = 0; viewYear++; } else viewMonth++;
    renderCalendar();
  });

  fab.addEventListener('click', () => openNewPayment(new Date(viewYear, viewMonth, 1)));

  /* ---------- Delete button in modal ---------- */
  btnDelete.addEventListener('click', ()=>{
    if(!pid.value) return;
    if(!confirm('Удалить платеж и последующие в серии? (будут удалены только последующие)')) return;
    deletePaymentAndFollowing(pid.value);
    save(); renderCalendar(); closeModal(modalAdd);
  });

  /* ---------- Helpers to open and edit ---------- */
  function openEditPayment(id){
    const p = payments.find(x=> x.id === id);
    if(!p) return;
    pid.value = p.id;
    pname.value = p.name;
    psum.value = p.sum;
    pdate.value = p.date;
    pcat.value = p.category;
    buildColorPicker();
    selectColorByColor(p.color);
    // set period radio
    const node = document.querySelector(`input[name="period"][value="${p.period}"]`);
    if(node) node.checked = true;
    autoSeriesCheckbox.checked = false;
    btnDelete.style.display = 'inline-block';
    openModal(modalAdd);
  }

  /* ---------- init color picker ---------- */
  function buildColorPicker(){
    colorPicker.innerHTML = '';
    Object.keys(CAT_COLORS).forEach(cat => {
      const b = document.createElement('button'); b.className='color-btn'; b.style.background = CAT_COLORS[cat]; b.dataset.cat = cat; b.dataset.color = CAT_COLORS[cat];
      b.title = capitalize(cat);
      b.addEventListener('click', ()=> {
        document.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('selected'));
        b.classList.add('selected');
      });
      colorPicker.appendChild(b);
    });
  }
  function selectColorByCategory(cat){
    const b = Array.from(colorPicker.children).find(x=> x.dataset.cat === cat);
    if(b){ document.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }
  }
  function selectColorByColor(color){
    const b = Array.from(colorPicker.children).find(x=> x.dataset.color === color);
    if(b){ document.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }
  }
  function getSelectedColor(){ const s = colorPicker.querySelector('.color-btn.selected'); return s ? s.dataset.color : (CAT_COLORS[pcat.value]||'#777'); }

  /* ---------- Boot ---------- */
  function init(){
    load();
    buildColorPicker();
    renderCalendar();
  }

  // expose for debugging
  window._payments = payments;
  window._reinit = () => { load(); renderCalendar(); };

  init();

})();
</script>
</body>
</html>
